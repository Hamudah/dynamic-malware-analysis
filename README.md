# Automation of Dynamic Malware Instrumentation

## A fully functional setup, to analyze malware inside of a Sandbox created via **VBoxManage CLI** and the **Virtualbox API** 

* First create a Windows and an Ubuntu virtuell machine via a VBoxManage Script
* Customize and set-up virtual machines for malware analysis (Download and set-up FTP, SSH, etc.)
* Set-up connection between VMs
* Loop Script with Malware/Goodware on the Windows Machine and extract Data via the Intel-Pin Tool
* Extract Data from the Ubuntu Machine

## Network Topology
![Network Diagramm](https://github.com/Hamudah/dynamic-malware-analysis/blob/main/Graphs/Network.png?raw=true)

## Requirements
To run the project locally on your PC, the following requirments are necessary:
* `Orcale VirtuelBox 7.0` [Link](https://www.virtualbox.org/wiki/Downloads) or newer
* Download the prepared ISO files [Link](https://o365adessogroup-my.sharepoint.com/:f:/g/personal/muhammed_adel_adesso_de/Ei8tYkVjHdBAs77yBDSv45YBCA18SmWu19hOj_tAwPspQw?e=eylSeM), or use your own iso files, which are supported to do an unattended installation. You can check if your ISO file supports this with `vboxmanage unattended detect --iso=/path/to/iso/file.iso`. Otherwise you could create your own Iso files, by using the config files in ` config_files/ `. For Windows the **Windows ADK** is needed and for Ubuntu **WSL**

## Installation
First download the repository in any directory on your Windows System

`git clone https://github.com/Hamudah/dynamic-malware-analysis.git`

**WARNING** Before you start with the next step, make sure that your system has enough resources, which are distributed to the VMs in the script. Change the script so that the system settings like, processor, ram, etc fit all on your system. Also change the path of the VBoxManage.exe, if you decide to install it somewhere else. Also a key is needed for the windows installation, if a full version is requiered. 

After you downloaded the repository execute the complete_setup.bat by either double clicking on it or over the command line. For that go into the main directory `dynamic-malware-analysis/` and execute the `./Scripts/batch/complete_setup`.bat. 

`.\Scripts\batch\complete_setup.bat` 

After that follow the instructions shown on the machines. If you didnt change any other part of the script, the User for both machines, should have `hamud` as username and password. If you want to change that, then change the username and password in line `81` and `82` in the `complete_setup.bat`. It may be in some cases that you even need to change the config file of the iso, and create a new iso, if the new name doesnt work. 

The next step would be to change the network settings of both VMs to "NAT" or any other network setting, where they have an active Internet connection. This will be only a temporary change, which we will revert after finishing the setup. Either change the network settings over the GUI or via VBoxManage command `VBoxManage modifyvm <VM_name> --nic1 nat`. 

Starting with the Ubuntu Machine, the first thing that needs to be done is giving our user Root. This can easily be done with the following commands:

```
su - 
#Password is "hamud"
sudo visudo

#At the end of the file add
<username> ALL=(ALL) ALL
```
After giving our User Root, install git for the cmd or download the repository on the gibhub page and copy it into the directory you want to work in.

In the repository execute following command
```
#Make all scripts executable
`chmod +x /Scripts/shell/*.sh`

#Execute the ftp-server script and openssh
./Scripts/shell/ftp_setup.sh
./Scripts/shell/openssh_setup.sh
```
Now on the Windows Machine we need to download the repository too. The first thing we should do then is execute `ninte.exe`. This downloads the most comman software and SDK to make the system seem as real as possible. As Editor I choose VSCode, but you can choose which ever you like. 

After the download finished we need any kind of SSH-Server. I decided to choose Bitvise-Server [Link](https://www.bitvise.com/ssh-server-download), but any SSH server should do. When we have everything installed, we can turn back the network settings to the Internal Network "MalwareAnalysis". Now we change the ip-addresses of the machines to `Ubuntu 192.178.162.1` and `Windows 192.178.162.2`. You can also leave the ip adresses as they are, but then need to change it to the correct ones in the scripts. 

You can test the connection by executing `test_ftp_connection.py`

Now on your Host-System create virtuell env for python following this guide [Link](https://code.visualstudio.com/docs/python/environments). Then go and download the VirtuelBox SDK [Link](https://www.virtualbox.org/wiki/Downloads). Make sure the `venv` is setup. Then go and download the SDK library `python sdk\installer\vboxapisetup.py install`. Depending on your system, it may be that you also need to install `pywin32` and `virtuelbox` from pip. This can be both done with following command: `pip install <library>`. 

What is missing now is to set in the firewall rules that the ports for SSH connection are open. Depending on what kind of malware analysis is operated, you can also turn off the firewall completely. Also create an **Base Snapshot** for you Windows machine, after the Setup is finished. Change line `74` in the power_on_vms_loop.py `snapshot = windows_machine.find_snapshot("Base Snapshot")` with the correct Snapshot name. 

Congratulations! The setup is done. You can now execute and loop malware via the `power_on_vms_loop.py` script.




